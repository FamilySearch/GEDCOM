# This action will copy changes from main into the v7.1 branch, and is done whenever the main branch is updated.
#
# For documentation on the github environment, see
# https://docs.github.com/en/actions/using-github-hosted-runners/about-github-hosted-runners
#
# For documentation on the syntax of this file, see
# https://docs.github.com/en/actions/reference/workflow-syntax-for-github-actions
---
name: Propagate main to 7.1

on:
  push:
    branches: [main]

permissions:
  contents: read

jobs:
  merge-to-v71:
    permissions:
      contents: write  # for Git to git push
      pull-requests: write  # for Git to create a pull request
    runs-on: ubuntu-latest

    steps:
      - name: Check out GEDCOM
        uses: actions/checkout@v6

      - name: Set git config
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          git config --global user.email "${GITHUB_ACTOR}@users.noreply.github.com"
          git config --global user.name "$(gh api /users/${GITHUB_ACTOR} | jq .name -r)"
          git config -l

      - name: Check for diffs excluding extracted-files
        id: diff
        run: |
          git fetch origin
          # Check for differences excluding extracted-files directory
          git diff --quiet origin/main..origin/v7.1 -- . ':!extracted-files' || echo "::set-output name=status::changes"

      - name: Create merge branch and copy files excluding extracted-files
        if: steps.diff.outputs.status == 'changes'
        run: |
          # Checkout v7.1 and create merge branch
          git checkout origin/v7.1
          git checkout -b merge-main-into-v7.1

          # Copy all files from main except extracted-files directory
          git checkout origin/main -- .
          git checkout origin/v7.1 -- extracted-files/

          # Stage the changes
          git add .

      - name: Create Pull Request
        if: steps.diff.outputs.status == 'changes'
        run: |
          # Check if there are actually changes to commit
          if ! git diff --cached --quiet; then
            git commit -m "Merge main into v7.1 (excluding extracted-files)"
            git push -f --set-upstream origin merge-main-into-v7.1
            if ! gh pr list | grep -q "merge-main-into-v7.1"; then
              gh pr create -B v7.1 -H merge-main-into-v7.1 --title 'Merge main into v7.1 (excluding extracted-files)' --body $'Copy changes from main to v7.1, excluding extracted-files directory\nThe extracted-files will be handled separately by the generate-files workflow\nThis PR is auto-generated by [gh pr create].' --label 'automated pr' --repo ${{ github.repository }}
            fi
          else
            echo "No changes to commit after excluding extracted-files"
          fi
        env:
          GH_TOKEN: ${{ secrets.WORKFLOW_TOKEN }}
